<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="userRecipeMapper">
    
    <sql id="recipeSearchCondition">
        <where>
            R.DELETE_STATUS = 'N'
            <if test="rcpMthNo != null and rcpMthNo != ''">
                AND R.RCP_MTH_NO = #{rcpMthNo}
            </if>
            <if test="rcpStaNo != null and rcpStaNo != ''">
                AND R.RCP_STA_NO = #{rcpStaNo}
            </if>
            <if test="ingredientList != null and !ingredientList.isEmpty()">
                <foreach item="ingredientName" collection="ingredientList">
                    AND EXISTS (
                        SELECT 1 
                        FROM RCP_INGREDIENT RI
                        JOIN INGREDIENT I ON RI.ING_NO = I.ING_NO
                        WHERE RI.RCP_NO = R.RCP_NO AND I.ING_NAME LIKE '%' || #{ingredientName} || '%'
                    )
                </foreach>
            </if>
        </where>
    </sql>

    <select id="selectRecipeList" parameterType="map" resultType="com.kh.ypjp.community.recipe.dto.UserRecipeDto$UserRecipeResponse">
        SELECT * FROM (
            SELECT
                R.RCP_NO        AS rcpNo,
                R.RCP_NAME      AS rcpName,
                R.CREATED_AT    AS createdAt,
                U.USERNAME,
                U.SIK_BTI       AS sikBti,
                RI.SERVER_NAME   AS serverName,
                UI.SERVER_NAME   AS userProfileImage,
                NVL(V.AVG_STARS, 0) AS avgStars,
                NVL(V.REVIEW_COUNT, 0) AS reviewCount
            FROM RECIPE R
            JOIN USERS U ON (R.USER_NO = U.USER_NO)
            LEFT JOIN IMAGE RI ON (R.IMAGE_NO = RI.IMAGE_NO)
            LEFT JOIN IMAGE UI ON (U.IMAGE_NO = UI.IMAGE_NO)
            LEFT JOIN (
                SELECT REF_NO, AVG(STARS) AS AVG_STARS, COUNT(*) AS REVIEW_COUNT
                FROM REVIEW WHERE RCP_SOURCE = 'RCP' GROUP BY REF_NO
            ) V ON R.RCP_NO = V.REF_NO
            <include refid="recipeSearchCondition"/>
            <choose>
                <when test="sort == 'stars'">
                    ORDER BY avgStars DESC, R.CREATED_AT DESC
                </when>
                <otherwise>
                    ORDER BY R.CREATED_AT DESC
                </otherwise>
            </choose>
        )
        OFFSET (#{page} * #{pageSize}) ROWS
        FETCH NEXT #{pageSize} ROWS ONLY
    </select>

    <select id="selectRecipeCount" parameterType="map" resultType="_long">
        SELECT COUNT(*)
        FROM RECIPE R
        <include refid="recipeSearchCondition"/>
    </select>

    <select id="selectRankingRecipes" resultType="com.kh.ypjp.community.recipe.dto.UserRecipeDto$UserRecipeResponse">
         SELECT * FROM (
            SELECT
                R.RCP_NO        AS rcpNo,
                R.RCP_NAME      AS rcpName,
                R.CREATED_AT    AS createdAt,
                U.USERNAME,
                U.SIK_BTI       AS sikBti,
                RI.SERVER_NAME   AS serverName,
                UI.SERVER_NAME   AS userProfileImage,
                NVL(V.AVG_STARS, 0) AS avgStars,
                NVL(V.REVIEW_COUNT, 0) AS reviewCount
            FROM RECIPE R
            JOIN USERS U ON (R.USER_NO = U.USER_NO)
            LEFT JOIN IMAGE  RI ON (R.IMAGE_NO = RI.IMAGE_NO)
            LEFT JOIN IMAGE  UI ON (U.IMAGE_NO = UI.IMAGE_NO)
            LEFT JOIN (
                SELECT REF_NO, AVG(STARS) AS AVG_STARS, COUNT(*) AS REVIEW_COUNT
                FROM REVIEW WHERE RCP_SOURCE = 'RCP' GROUP BY REF_NO
            ) V ON R.RCP_NO = V.REF_NO
            JOIN (
                SELECT REF_NO, COUNT(*) AS LIKE_COUNT
                FROM LIKES
                WHERE REF_TYPE = 'RCP'
                  AND LIKE_STATUS = 'LIKE' -- '좋아요' 상태만 카운트
                  AND LIKED_AT >= TRUNC(SYSDATE, 'MM') -- 이번 달 1일 00시부터
                  AND LIKED_AT &lt; ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1) -- 다음 달 1일 00시 전까지
                GROUP BY REF_NO
            ) L ON R.RCP_NO = L.REF_NO
            WHERE R.DELETE_STATUS = 'N'
            ORDER BY L.LIKE_COUNT DESC, R.CREATED_AT DESC
        )
        FETCH FIRST 4 ROWS ONLY
</select>

    <select id="selectRcpMethods" resultType="com.kh.ypjp.community.recipe.model.vo.RcpMethod">
        SELECT RCP_MTH_NO, RCP_METHOD 
        FROM RCP_METHOD
    </select>

    <select id="selectRcpSituations" resultType="com.kh.ypjp.community.recipe.model.vo.RcpSituation">
        SELECT RCP_STA_NO, RCP_SITUATION 
        FROM RCP_SITUATION
    </select>

    <select id="searchIngredients" parameterType="string" resultType="com.kh.ypjp.community.recipe.dto.UserRecipeDto$IngredientInfo">
        SELECT I.ING_NO AS ingNo, I.ING_NAME AS ingName, N.ENERGY, N.CARB, N.PROTEIN, N.FAT, N.SODIUM
        FROM INGREDIENT I
        JOIN NUTRIENT N ON I.NUTRIENT_NO = N.NUTRIENT_NO
        WHERE I.ING_NAME LIKE '%' || #{keyword} || '%'
    </select>



    <insert id="insertImage" parameterType="map">
		<selectKey keyProperty="imageNo" resultType="_int" order="BEFORE">
			SELECT SEQ_IMAGE_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO IMG (IMAGE_NO, ORIGIN_NAME, SERVER_NAME)
		VALUES (#{imageNo}, #{originName}, #{serverName})
	</insert>

    <insert id="insertNutrient" parameterType="Nutrient">
        <selectKey keyProperty="nutrientNo" resultType="_int" order="BEFORE">
            SELECT SEQ_NUTRIENT_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO NUTRIENT (NUTRIENT_NO, ENERGY, CARB, PROTEIN, FAT, SODIUM)
        VALUES (#{nutrientNo}, #{energy}, #{carb}, #{protein}, #{fat}, #{sodium})
    </insert>
	
    <select id="getNextRcpNo" resultType="_long">
        SELECT SEQ_RECIPE_NO.NEXTVAL FROM DUAL
    </select>
    
    <insert id="insertRecipe" parameterType="Recipe">
        INSERT INTO RECIPE (
            RCP_NO, USER_NO, RCP_NAME, RCP_INFO, RCP_MTH_NO,
            RCP_STA_NO, TAG, IMAGE_NO, NUTRIENT_NO
        ) VALUES (
            #{rcpNo}, #{userNo}, #{rcpName}, #{rcpInfo}, #{rcpMthNo},
            #{rcpStaNo}, #{tag}, #{imageNo}, #{nutrientNo}
        )
    </insert>

    <insert id="insertRcpIngredient" parameterType="com.kh.ypjp.community.recipe.model.vo.RcpIngredient">
	    INSERT INTO RCP_INGREDIENT (RCP_NO, ING_NO, QUANTITY, WEIGHT)
	    VALUES (#{rcpNo}, #{ingNo}, #{quantity}, #{weight})
	</insert>

    <insert id="insertRcpDetail" parameterType="com.kh.ypjp.community.recipe.model.vo.RcpDetail">
	    INSERT INTO RCP_DETAIL (RCP_NO, RCP_ORDER, DESCRIPTION, IMAGE_NO)
	    VALUES (#{rcpNo}, #{rcpOrder}, #{description}, #{imageNo})
	</insert>
	
	<select id="findNutrientsByIngNo" parameterType="_int" resultType="Nutrient">
	    SELECT
	        N.NUTRIENT_NO AS nutrientNo,
	        N.ENERGY,
	        N.CARB,
	        N.PROTEIN,
	        N.FAT,
	        N.SODIUM
	    FROM INGREDIENT I
	    JOIN NUTRIENT N ON I.NUTRIENT_NO = N.NUTRIENT_NO
	    WHERE I.ING_NO = #{ingNo}
	</select>
	
	<update id="increaseViewCount" parameterType="_int">
        UPDATE RECIPE
        SET VIEWS = VIEWS + 1
        WHERE RCP_NO = #{rcpNo}
    </update>




	<resultMap id="recipeDetailResultMap" type="com.kh.ypjp.community.recipe.dto.UserRecipeDto$RecipeDetailResponse">
	    <id property="rcpNo" column="rcpNo"/>
	    <result property="rcpName" column="rcpName"/>
	    <result property="rcpInfo" column="rcpInfo"/>
	    <result property="createdAt" column="createdAt"/>
	    <result property="views" column="VIEWS"/>
	    <result property="tag" column="TAG"/>
	    <result property="isOfficial" column="isOfficial"/>
	    <result property="rcpMethod" column="rcpMethod"/>
	    <result property="rcpSituation" column="rcpSituation"/>
	    <result property="mainImage" column="mainImage"/>
	    <result property="reviewCount" column="reviewCount"/>
	    <result property="avgStars" column="avgStars"/>
	    <result property="likeCount" column="likeCount"/>
	    <association property="writer" javaType="com.kh.ypjp.community.recipe.dto.UserRecipeDto$RecipeDetailResponse$Writer">
	        <result property="userNo" column="writer.userNo"/>
	        <result property="username" column="writer.username"/>
	        <result property="sikBti" column="writer.sikBti"/>
	        <result property="profileImage" column="writer.profileImage"/>
	    </association>
	
	    <association property="totalNutrient" javaType="com.kh.ypjp.common.model.vo.Nutrient">
	        <result property="energy" column="totalNutrient.energy"/>
	        <result property="carb" column="totalNutrient.carb"/>
	        <result property="protein" column="totalNutrient.protein"/>
	        <result property="fat" column="totalNutrient.fat"/>
	        <result property="sodium" column="totalNutrient.sodium"/>
	    </association>
	</resultMap>
	
	<select id="selectRecipeDetail" parameterType="map" resultMap="recipeDetailResultMap">
	    SELECT
	        R.RCP_NO         AS rcpNo,
	        R.RCP_NAME       AS rcpName,
	        R.RCP_INFO       AS rcpInfo,
	        R.CREATED_AT     AS createdAt,
	        R.VIEWS,
	        R.TAG,
	        CASE WHEN R.USER_NO IS NULL THEN 1 ELSE 0 END AS isOfficial,
	        RM.RCP_METHOD    AS rcpMethod,
	        RS.RCP_SITUATION AS rcpSituation,
	        IMG.SERVER_NAME  AS mainImage,
	        U.USER_NO        AS "writer.userNo",
	        U.USERNAME       AS "writer.username",
	        U.SIK_BTI        AS "writer.sikBti",
	        U_IMG.SERVER_NAME AS "writer.profileImage",
	        N.ENERGY         AS "totalNutrient.energy",
	        N.CARB           AS "totalNutrient.carb",
	        N.PROTEIN        AS "totalNutrient.protein",
	        N.FAT            AS "totalNutrient.fat",
	        N.SODIUM         AS "totalNutrient.sodium",
	        NVL(REV.REVIEW_COUNT, 0) AS reviewCount,
	        NVL(REV.AVG_STARS, 0) AS avgStars,
	        (SELECT COUNT(*) FROM LIKES WHERE REF_NO = R.RCP_NO AND REF_TYPE = 'RCP' AND LIKE_STATUS = 'LIKE') AS likeCount
	    FROM RECIPE R
	    LEFT JOIN USERS U ON R.USER_NO = U.USER_NO
	    LEFT JOIN IMAGE IMG ON R.IMAGE_NO = IMG.IMAGE_NO
	    LEFT JOIN IMAGE U_IMG ON U.IMAGE_NO = U_IMG.IMAGE_NO
	    LEFT JOIN RCP_METHOD RM ON R.RCP_MTH_NO = RM.RCP_MTH_NO
	    LEFT JOIN RCP_SITUATION RS ON R.RCP_STA_NO = RS.RCP_STA_NO
	    LEFT JOIN NUTRIENT N ON R.NUTRIENT_NO = N.NUTRIENT_NO
	    LEFT JOIN (
	        SELECT REF_NO, COUNT(*) AS REVIEW_COUNT, AVG(STARS) AS AVG_STARS
	        FROM REVIEW WHERE RCP_SOURCE = 'RCP' GROUP BY REF_NO
	    ) REV ON R.RCP_NO = REV.REF_NO
	    WHERE R.RCP_NO = #{rcpNo}
	</select>
	
	<select id="findLikeStatus" parameterType="map" resultType="string">
	    SELECT LIKE_STATUS
	    FROM LIKES
	    WHERE USER_NO = #{userNo}
	      AND REF_TYPE = 'RCP'
	      AND REF_NO = #{rcpNo}
	</select>
	
	<select id="selectIngredientsByRcpNo" parameterType="_int" resultType="com.kh.ypjp.community.recipe.model.vo.RcpIngredient">
	    SELECT
	        I.ING_NAME      AS ingName,
	        RI.QUANTITY,
	        RI.WEIGHT
	    FROM RCP_INGREDIENT RI
	    JOIN INGREDIENT I ON RI.ING_NO = I.ING_NO
	    WHERE RI.RCP_NO = #{rcpNo}
	</select>
	
	<select id="selectStepsByRcpNo" parameterType="_int" resultType="com.kh.ypjp.community.recipe.model.vo.CookingStep">
	    SELECT
	        RD.RCP_ORDER    AS rcpOrder,
	        RD.DESCRIPTION,
	        I.SERVER_NAME   AS serverName
	    FROM RCP_DETAIL RD
	    LEFT JOIN IMAGE I ON RD.IMAGE_NO = I.IMAGE_NO
	    WHERE RD.RCP_NO = #{rcpNo}
	    ORDER BY RD.RCP_ORDER ASC
	</select>

    

</mapper>