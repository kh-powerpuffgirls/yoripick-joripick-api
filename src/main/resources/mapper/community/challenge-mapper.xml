<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.ypjp.community.challenge.dao.ChallengeDao">

    <!-- ===================== DTO 매핑 ===================== -->
    <resultMap id="ChallengeDtoResultMap" type="com.kh.ypjp.community.challenge.dto.ChallengeDto">
        <id property="challengeNo" column="CHALLENGE_NO"/>
        <result property="userNo" column="USER_NO"/>
        <result property="chInfoNo" column="CH_INFO_NO"/>
        <result property="videoUrl" column="VIDEO_URL"/>
        <result property="views" column="VIEWS"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="username" column="USERNAME"/>
        <result property="sik_bti" column="SIK_BTI"/>
        <result property="title" column="TITLE"/>
        <result property="startDate" column="START_DATE"/>
        <result property="endDate" column="END_DATE"/>
        <result property="serverName" column="SERVER_NAME"/>
        <result property="likes" column="LIKES"/>
    </resultMap>

    <!-- ChallengeInfoDto 매핑 -->
    <resultMap id="ChallengeInfoDtoResultMap" type="com.kh.ypjp.community.challenge.dto.ChallengeInfoDto">
        <id property="chInfoNo" column="CH_INFO_NO" />
        <result property="title" column="TITLE" />
        <result property="startDate" column="START_DATE" />
        <result property="endDate" column="END_DATE" />
        <result property="imageNo" column="IMAGE_NO" jdbcType="INTEGER" />
    </resultMap>
    
    <!-- ChallengeSuggestionDto 매핑 -->
    <resultMap id="ChallengeSuggestionDtoResultMap" type="com.kh.ypjp.community.challenge.dto.ChallengeSuggestionDto">
        <id property="formNo" column="FORM_NO" />
        <result property="userNo" column="USER_NO" />
        <result property="chTitle" column="CH_TITLE" />
        <result property="description" column="DESCRIPTION" />
        <result property="reference" column="REFERENCE" />
    </resultMap>

    <!-- ChallengeReplyDto 매핑 -->
    <resultMap id="ChallengeReplyResultMap" type="com.kh.ypjp.community.challenge.dto.ChallengeReplyDto">
        <result property="replyNo" column="REPLY_NO"/>
        <result property="refNo" column="REF_NO"/>
        <result property="userNo" column="USER_NO"/>
        <result property="content" column="CONTENT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="username" column="USERNAME"/>
        <result property="profileImageServerName" column="PROFILE_IMAGE_SERVER_NAME"/>
        <result property="category" column="CATEGORY"/>
        <result property="sik_bti" column="SIK_BTI"/>
    </resultMap>

    <!-- ===================== 챌린지 조회 ===================== -->

    <select id="findAll" resultMap="ChallengeDtoResultMap">
        SELECT
            c.CHALLENGE_NO,
            c.USER_NO,
            c.CH_INFO_NO,
            c.VIDEO_URL,
            c.VIEWS,
            c.CREATED_AT,
            u.USERNAME,
            u.SIK_BTI AS SIK_BTI,
            ci.TITLE,
            ci.START_DATE,
            ci.END_DATE,
            i.SERVER_NAME AS SERVER_NAME,
            (SELECT COUNT(*) 
             FROM LIKES l 
             WHERE l.REF_TYPE = 'CHALLENGE' AND l.REF_NO = c.CHALLENGE_NO) AS LIKES
        FROM CHALLENGE c
        JOIN USERS u ON c.USER_NO = u.USER_NO
        JOIN CHALLENGE_INFO ci ON c.CH_INFO_NO = ci.CH_INFO_NO
        LEFT JOIN IMAGE i ON c.IMAGE_NO = i.IMAGE_NO
        WHERE c.DELETE_STATUS = 'N'
        ORDER BY c.CREATED_AT DESC
    </select>
    
            <select id="findNextChallenge" resultType="java.lang.Long">
        SELECT MIN(CHALLENGE_NO)
        FROM CHALLENGE
        WHERE CHALLENGE_NO > #{challengeNo} AND DELETE_STATUS = 'N'
    </select>

    <select id="findPreviousChallenge" resultType="java.lang.Long">
        SELECT MAX(CHALLENGE_NO)
        FROM CHALLENGE
        WHERE CHALLENGE_NO &lt; #{challengeNo} AND DELETE_STATUS = 'N'
    </select>

    <select id="findActiveChallengeInfo" resultMap="ChallengeInfoDtoResultMap">
        SELECT CH_INFO_NO, TITLE, START_DATE, END_DATE
        FROM CHALLENGE_INFO
        WHERE TRUNC(SYSDATE) BETWEEN START_DATE AND END_DATE
    </select>


<!-- 특정 챌린지 작성자 조회 -->
<select id="findUserNoById" parameterType="long" resultType="long">
    SELECT USER_NO
    FROM CHALLENGE
    WHERE CHALLENGE_NO = #{challengeNo}
</select>

    <select id="findActiveChallenges" resultMap="ChallengeDtoResultMap">
        SELECT
            c.CHALLENGE_NO, c.USER_NO, c.CH_INFO_NO, c.VIDEO_URL, c.VIEWS, c.CREATED_AT,
            u.USERNAME,
            u.SIK_BTI AS SIK_BTI,
            ci.TITLE, ci.START_DATE, ci.END_DATE,
            i.SERVER_NAME AS SERVER_NAME,
            (SELECT COUNT(*) FROM LIKES l WHERE l.REF_TYPE = 'CHALLENGE' AND l.REF_NO = c.CHALLENGE_NO) AS LIKES
        FROM CHALLENGE c
        JOIN USERS u ON c.USER_NO = u.USER_NO
        JOIN CHALLENGE_INFO ci ON c.CH_INFO_NO = ci.CH_INFO_NO
        LEFT JOIN IMAGE i ON c.IMAGE_NO = i.IMAGE_NO
        WHERE c.DELETE_STATUS = 'N' AND TRUNC(SYSDATE) BETWEEN ci.START_DATE AND ci.END_DATE
        ORDER BY c.CREATED_AT DESC
    </select>

    <select id="findById" parameterType="long" resultMap="ChallengeDtoResultMap">
        SELECT
            c.CHALLENGE_NO, c.USER_NO, c.CH_INFO_NO, c.VIDEO_URL, c.VIEWS, c.CREATED_AT, c.IMAGE_NO,
            u.USERNAME,
            u.SIK_BTI AS SIK_BTI,
            ci.TITLE, ci.START_DATE, ci.END_DATE,
            i.SERVER_NAME AS SERVER_NAME,
            (SELECT COUNT(*) FROM LIKES l WHERE l.REF_TYPE = 'CHALLENGE' AND l.REF_NO = c.CHALLENGE_NO) AS LIKES
        FROM CHALLENGE c
        JOIN USERS u ON c.USER_NO = u.USER_NO
        JOIN CHALLENGE_INFO ci ON c.CH_INFO_NO = ci.CH_INFO_NO
        LEFT JOIN IMAGE i ON c.IMAGE_NO = i.IMAGE_NO
        WHERE c.CHALLENGE_NO = #{challengeNo} AND c.DELETE_STATUS = 'N'
    </select>

    <!-- ===================== 좋아요(Like) 관련 ===================== -->
    <select id="getLikesCount" resultType="java.lang.Integer">
        SELECT COUNT(*) 
        FROM LIKES 
        WHERE REF_TYPE = 'CHALLENGE' AND REF_NO = #{challengeNo}
    </select>

    <select id="checkIfLiked" resultType="int">
        SELECT COUNT(*)
        FROM LIKES
        WHERE USER_NO = #{userNo}
          AND REF_TYPE = 'CHALLENGE'
          AND REF_NO = #{challengeNo}
    </select>
	    
	<!-- 좋아요 / 싫어요 등록 또는 변경 -->
	<update id="insertOrUpdateLike">
	    MERGE INTO LIKES l
	    USING (SELECT #{userNo} AS user_no, 
	                  #{challengeNo} AS ref_no, 
	                  'CHALLENGE' AS ref_type 
	           FROM dual) t
	    ON (l.user_no = t.user_no AND l.ref_no = t.ref_no AND l.ref_type = t.ref_type)
	    WHEN MATCHED THEN
	        UPDATE SET l.like_status = #{likeStatus}, 
	                   l.liked_at = SYSDATE
	    WHEN NOT MATCHED THEN
	        INSERT (user_no, ref_type, ref_no, like_status, liked_at)
	        VALUES (#{userNo}, 'CHALLENGE', #{challengeNo}, #{likeStatus}, SYSDATE)
	</update>
	
	<!-- 특정 사용자의 챌린지 좋아요 상태 조회 -->
	<select id="findLikeStatus" resultType="String">
	    SELECT LIKE_STATUS
	    FROM LIKES
	    WHERE USER_NO = #{userNo}
	      AND REF_TYPE = 'CHALLENGE'
	      AND REF_NO = #{challengeNo}
	</select>
	
	<!-- 좋아요/싫어요 취소 -->
	<update id="deleteLike">
	    UPDATE LIKES
	    SET LIKE_STATUS = 'COMMON', liked_at = SYSDATE
	    WHERE USER_NO = #{userNo} 
	      AND REF_TYPE = 'CHALLENGE' 
	      AND REF_NO = #{challengeNo}
	</update>

    <!-- ===================== 이미지 관련 ===================== -->
    <insert id="insertImage" parameterType="map">
        <selectKey keyProperty="imageNo" resultType="int" order="BEFORE">
            SELECT SEQ_IMAGE_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO IMAGE (IMAGE_NO, ORIGIN_NAME, SERVER_NAME)
        VALUES (#{imageNo}, #{originName}, #{serverName})
    </insert>

    <update id="updateImage" parameterType="map">
        UPDATE IMAGE
        SET ORIGIN_NAME = #{originName}, SERVER_NAME = #{serverName}
        WHERE IMAGE_NO = #{imageNo}
    </update>

    <delete id="deleteImageByImageNo" parameterType="int">
        DELETE FROM IMAGE WHERE IMAGE_NO = #{imageNo}
    </delete>

    <update id="updateChallengeImageNo">
        UPDATE CHALLENGE SET IMAGE_NO = #{imageNo} WHERE CHALLENGE_NO = #{challengeNo}
    </update>

    <select id="selectImageNoByChallengeNo" resultType="int">
        SELECT IMAGE_NO FROM CHALLENGE WHERE CHALLENGE_NO = #{challengeNo}
    </select>
    
    <select id="findByIdWithImage" parameterType="long" resultMap="ChallengeDtoResultMap">
        SELECT
            c.CHALLENGE_NO, c.USER_NO, c.CH_INFO_NO, c.VIDEO_URL, c.VIEWS, c.CREATED_AT, c.IMAGE_NO,
            u.USERNAME,
            u.SIK_BTI AS SIK_BTI,
            ci.TITLE, ci.START_DATE, ci.END_DATE,
            i.SERVER_NAME AS SERVER_NAME,
            (SELECT COUNT(*) FROM LIKES l WHERE l.REF_TYPE = 'CHALLENGE' AND l.REF_NO = c.CHALLENGE_NO) AS LIKES
        FROM CHALLENGE c
        JOIN USERS u ON c.USER_NO = u.USER_NO
        JOIN CHALLENGE_INFO ci ON c.CH_INFO_NO = ci.CH_INFO_NO
        LEFT JOIN IMAGE i ON c.IMAGE_NO = i.IMAGE_NO
        WHERE c.CHALLENGE_NO = #{challengeNo} AND c.DELETE_STATUS = 'N'
    </select>

    <!-- ===================== 챌린지 등록/수정 ===================== -->
    <insert id="saveChallenge">
        <selectKey keyProperty="challengeNo" resultType="long" order="BEFORE">
            SELECT SEQ_CHALLENGE_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO CHALLENGE (CHALLENGE_NO, USER_NO, CH_INFO_NO, VIDEO_URL, IMAGE_NO)
        VALUES (#{challengeNo}, #{userNo}, #{chInfoNo}, #{videoUrl}, #{imageNo})
    </insert>

    <update id="update" parameterType="com.kh.ypjp.community.challenge.dto.ChallengeDto">
        UPDATE CHALLENGE
        SET VIDEO_URL = #{videoUrl}
        <if test="imageNo != null">, IMAGE_NO = #{imageNo}</if>
        WHERE CHALLENGE_NO = #{challengeNo}
    </update>

    <update id="updateDeleteStatus">
        UPDATE CHALLENGE SET DELETE_STATUS = #{deleteStatus} WHERE CHALLENGE_NO = #{challengeNo}
    </update>

    <update id="incrementViews" parameterType="long">
        UPDATE CHALLENGE SET VIEWS = VIEWS + 1 WHERE CHALLENGE_NO = #{challengeNo}
    </update>

    <!-- ===================== 댓글(Reply) 관련 ===================== -->
    <select id="selectAllRepliesByChallengeId" parameterType="long" resultMap="ChallengeReplyResultMap">
        SELECT R.REPLY_NO, R.REF_NO, R.USER_NO, R.CONTENT, R.CREATED_AT, R.CATEGORY,
               U.USERNAME, U.SIK_BTI AS SIK_BTI, I.SERVER_NAME AS PROFILE_IMAGE_SERVER_NAME
        FROM REPLY R
        JOIN USERS U ON R.USER_NO = U.USER_NO
        LEFT JOIN IMAGE I ON U.IMAGE_NO = I.IMAGE_NO
        START WITH R.REF_NO = #{challengeNo} AND R.CATEGORY = 'CHALLENGE'
        CONNECT BY PRIOR R.REPLY_NO = R.REF_NO
        ORDER SIBLINGS BY R.CREATED_AT ASC
    </select>

    <insert id="insertReply" parameterType="com.kh.ypjp.community.challenge.dto.ChallengeReplyDto">
        <selectKey keyProperty="replyNo" resultType="Long" order="BEFORE">
            SELECT SEQ_REPLY_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO REPLY (REPLY_NO, REF_NO, USER_NO, CONTENT, CATEGORY, CREATED_AT)
        VALUES (#{replyNo}, #{refNo}, #{userNo}, #{content}, #{category}, SYSDATE)
    </insert>

    <update id="updateReply" parameterType="com.kh.ypjp.community.challenge.dto.ChallengeReplyDto">
        UPDATE REPLY SET CONTENT = #{content} WHERE REPLY_NO = #{replyNo}
    </update>

    <select id="selectReplyById" resultType="com.kh.ypjp.community.challenge.dto.ChallengeReplyDto">
        SELECT * FROM REPLY WHERE REPLY_NO = #{replyNo}
    </select>

    <delete id="deleteReply">
        DELETE FROM REPLY WHERE REPLY_NO = #{replyNo} AND USER_NO = #{userNo}
    </delete>

    <select id="checkCircularReference" resultType="int">
        SELECT COUNT(*)
        FROM REPLY
        START WITH REPLY_NO = #{newRefNo}
        CONNECT BY NOCYCLE PRIOR REF_NO = REPLY_NO
        WHERE REPLY_NO = #{replyNo}
    </select>

    <!-- ===================== 챌린지 제안(Suggestion) ===================== -->
    <insert id="insertSuggestion" parameterType="com.kh.ypjp.community.challenge.dto.ChallengeSuggestionDto">
        <selectKey keyProperty="formNo" resultType="int" order="BEFORE">
            SELECT SEQ_CH_FORM_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO CHALLENGE_FORM (FORM_NO, USER_NO, CH_TITLE, DESCRIPTION, REFERENCE)
        VALUES (#{formNo}, #{userNo}, #{chTitle}, #{description}, #{reference})
    </insert>

</mapper>
