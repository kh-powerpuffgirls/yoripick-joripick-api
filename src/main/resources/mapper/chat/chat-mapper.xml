<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chat">
	<resultMap id="chatRoomResultMap" type="com.kh.ypjp.chat.model.dto.ChatDto$ChatRoomDto">
        <result property="roomNo" column="roomNo"/>
        <result property="className" column="className"/>
        <result property="type" column="type"/>
        <result property="notification" column="notification"/>
    </resultMap>
    
    <select id="getAllCserviceRooms" resultMap="chatRoomResultMap">
		SELECT room_no AS roomNo,
				username AS className,
               'admin' AS type
        FROM CUSTOMER_SERVICE
        JOIN USERS USING (user_no)
	</select>

	<select id="findCookingClasses" resultMap="chatRoomResultMap">
		SELECT cc.room_no AS roomNo,
               cc.class_name AS className,
               'cclass' AS type,
               ce.notification
        FROM cooking_class cc
        JOIN class_enroll ce ON ce.room_no = cc.room_no
        WHERE ce.user_no = #{userNo}
	</select>
	
	<select id="findFaqChat" resultType="int">
		SELECT count(*) FROM CHATBOT
		WHERE user_no = #{userNo}
	</select>
	
	<select id="findAdminChat" resultType="long">
		SELECT room_no FROM CUSTOMER_SERVICE
		WHERE user_no = #{userNo}
	</select>
	
	<select id="getMessagesByRoom" resultType="com.kh.ypjp.chat.model.dto.ChatDto$ChatMsgDto">
	    SELECT
	        M.message_no,
	        M.msg_type,
	        M.ref_no,
	        M.time as createdAt,
	        M.hidden,
	        M.image_no,
	        M.user_no,
	        U.username,
	        M.content,
	        M.ref_no as roomNo
	    FROM MESSAGE M
	    JOIN USERS U ON U.user_no = M.user_no
	    WHERE M.ref_no = #{refNo}
	    	AND M.msg_type = #{msgType}
	    	<if test="msgType == 'CCLASS'">
			    AND M.time >= (
			        SELECT CE.join_time
			        FROM CLASS_ENROLL CE
			        WHERE CE.room_no = M.ref_no
			          	AND CE.user_no = #{userNo}
			    )
			 </if>
		ORDER BY M.time
	</select>

	<resultMap id="faqResultMap" type="com.kh.ypjp.chat.model.dto.ChatDto$FaqMsgDto">
	    <constructor>
	        <arg column="userNo" javaType="long"/>
	        <arg column="username" javaType="string"/>
	        <arg column="content" javaType="string"/>
	        <arg column="linkUrl" javaType="string"/>
	        <arg column="createdAt" javaType="date"/>
	        <arg column="roomNo" javaType="long"/>
	    </constructor>
	</resultMap>
	
	<select id="getFaqByUser" resultMap="faqResultMap">
	    SELECT
	    	c.user_no AS userNo,
		    CASE 
				WHEN c.role = 'USER' THEN u.username
				WHEN c.role = 'BOT'  THEN '요픽'
			END AS username,
		    c.content,
		    c.link_url AS linkUrl,
		    c.created_at AS createdAt,
		    0 AS roomNo
	    FROM CHATBOT c
	    JOIN USERS u ON c.user_no = u.user_no
	    WHERE c.user_no = #{userNo}
	    ORDER BY c.created_at
	</select>
	
	<delete id="deleteFaqChat">
		DELETE FROM CHATBOT
		WHERE user_no = #{userNo}
	</delete>
	
	<delete id="deleteAdminChatMessage">
		DELETE FROM MESSAGE
		WHERE msg_type = 'CSERVICE'
			AND user_no = #{userNo}
	</delete>
	
	<delete id="deleteAdminChatSession">
		DELETE FROM CUSTOMER_SERVICE
		WHERE user_no = #{userNo}
	</delete>
	
	<insert id="insertChatBot">
		INSERT INTO CHATBOT (chatbot_no, user_no, role, content, link_url) 
		VALUES (SEQ_CHATBOT_NO.NEXTVAL, #{userNo}, #{username}, #{content}, #{button.linkUrl})
	</insert>
	
	<select id="getCsNoByUserNo" resultType="long">
		SELECT room_no FROM CUSTOMER_SERVICE
		WHERE user_no = #{userNo}
	</select>
	
	<insert id="insertCservice">
		INSERT INTO CUSTOMER_SERVICE (room_no, user_no)
		VALUES (SEQ_ROOM_NO.NEXTVAL, #{userNo})
	</insert>
	
	<insert id="insertMessage">
		<selectKey keyProperty="messageNo" resultType="long" order="BEFORE">
			SELECT SEQ_MESSAGE_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO MESSAGE (
			message_no, 
			user_no, 
			msg_type, 
			ref_no, 
			content
			<if test="imageNo != null">, image_no</if>)
		VALUES (
			#{messageNo}, 
			#{userNo}, 
			#{msgType}, 
			#{roomNo}, 
			#{content}
			<if test="imageNo != null">, #{imageNo}</if>)
	</insert>
</mapper>