<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.ypjp.community.mypost.dao.MyPostDao">

<!-- 내 게시물 통합 조회 -->
<select id="findPostsByUser" parameterType="int" resultType="com.kh.ypjp.community.mypost.dto.MyPostDto">
    SELECT * FROM (
        SELECT board_no AS id,
               title,
               content AS description,
               created_at AS createdDate,
               views,
               user_no AS userId,
               'BOARD' AS category
        FROM BOARD
        WHERE user_no = #{userId}
        UNION ALL
        SELECT rcp_no AS id,
               rcp_name AS title,
               rcp_info AS description,
               created_at AS createdDate,
               views,
               user_no AS userId,
               'RECIPE' AS category
        FROM RECIPE
        WHERE user_no = #{userId}
        UNION ALL
        SELECT challenge_no AS id,
               '' AS title,
               '' AS description,
               created_at AS createdDate,
               views,
               user_no AS userId,
               'CHALLENGE' AS category
        FROM CHALLENGE
        WHERE user_no = #{userId}
        UNION ALL
        SELECT product_id AS id,
               title,
               detail AS description,
               created_at AS createdDate,
               views,
               user_no AS userId,
               'MARKET' AS category
        FROM MARKETPLACE
        WHERE user_no = #{userId}
    ) temp
    ORDER BY createdDate DESC
</select>


    <!-- 게시글 상세 조회 -->
    <select id="findPostDetail" parameterType="map" resultType="com.kh.ypjp.community.mypost.dto.MyPostDto">
        <choose>
            <when test="category == 'BOARD'">
                SELECT board_no AS id, title, content AS description, created_at AS CREATED_DATE, views, user_no AS userId, 'BOARD' AS category
                FROM BOARD
                WHERE board_no = #{id}
            </when>
            <when test="category == 'RECIPE'">
                SELECT rcp_no, rcp_name, rcp_info, created_at AS CREATED_DATE, views, user_no, 'RECIPE'
                FROM RECIPE
                WHERE rcp_no = #{id}
            </when>
            <when test="category == 'CHALLENGE'">
                SELECT challenge_no, '' AS title, '' AS description, created_at AS CREATED_DATE, views, user_no, 'CHALLENGE'
                FROM CHALLENGE
                WHERE challenge_no = #{id}
            </when>
            <when test="category == 'MARKET'">
                SELECT product_id, title, detail AS description, created_at AS CREATED_DATE, views, user_no, 'MARKET'
                FROM MARKETPLACE
                WHERE product_id = #{id}
            </when>
        </choose>
    </select>

    <!-- 조회수 증가 -->
    <update id="incrementViews" parameterType="map">
        <choose>
            <when test="category == 'BOARD'">
                UPDATE BOARD SET views = views + 1 WHERE board_no = #{id}
            </when>
            <when test="category == 'RECIPE'">
                UPDATE RECIPE SET views = views + 1 WHERE rcp_no = #{id}
            </when>
            <when test="category == 'CHALLENGE'">
                UPDATE CHALLENGE SET views = views + 1 WHERE challenge_no = #{id}
            </when>
            <when test="category == 'MARKET'">
                UPDATE MARKETPLACE SET views = views + 1 WHERE product_id = #{id}
            </when>
        </choose>
    </update>

</mapper>
