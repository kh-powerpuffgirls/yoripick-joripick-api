<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="menumapper">

	 <select id="selectRecipe" parameterType="map" resultType="com.kh.ypjp.community.recipe.dto.UserRecipeDto$UserRecipeResponse">
        SELECT
            RCP_NO, USER_NO, RCP_NAME, CATEGORY_NO,
            IMAGE_NO, VIEWS, CREATED_AT
        FROM RECIPE
        <where>
            <if test="ingredient != null and ingredient != ''">
                AND INGREDIENT LIKE CONCAT('%', #{ingredient}, '%')
            </if>
            <if test="rcp_mth_no != null and rcp_mth_no != ''">
                AND RCP_MTH_NO = #{rcp_mth_no}
            </if>
            <if test="rcp_sta_no != null and rcp_sta_no != ''">
                AND RCP_STA_NO = #{rcp_sta_no}
            </if>
        </where>
        <choose>
            <when test="sort != null and sort == 'stars'">
                ORDER BY STARS DESC
            </when>
            <otherwise>
                ORDER BY CREATED_AT DESC
            </otherwise>
        </choose>
    </select>

    <select id="selectRcpMethods" resultType="com.kh.ypjp.community.recipe.model.vo.RcpMethod">
        SELECT RCP_MTH_NO, RCP_METHOD FROM RCP_METHOD
    </select>

    <select id="selectRcpSituations" resultType="com.kh.ypjp.community.recipe.model.vo.RcpSituation">
        SELECT RCP_STA_NO, RCP_SITUATION FROM RCP_SITUATION
    </select>

    <select id="searchIngredients" parameterType="string" resultType="com.kh.ypjp.community.recipe.dto.UserRecipeDto$IngredientInfo">
        SELECT I.ING_NO, I.ING_NAME, N.ENERGY, N.CARB, N.PROTEIN, N.FAT, N.SODIUM
        FROM INGREDIENT I
        JOIN NUTRIENT N ON I.NUTRIENT_NO = N.NUTRIENT_NO
        WHERE I.ING_NAME LIKE CONCAT('%', #{keyword}, '%')
    </select>

    <insert id="insertImage" parameterType="com.kh.ypjp.common.model.vo.Image" useGeneratedKeys="true" keyProperty="imageNo">
        INSERT INTO IMAGE (ORIGINAL_NAME, SERVER_NAME)
        VALUES (#{originalName}, #{serverName})
    </insert>

    <insert id="insertNutrient" parameterType="com.kh.ypjp.common.model.vo.Nutrient" useGeneratedKeys="true" keyProperty="nutrientNo">
        INSERT INTO NUTRIENT (ENERGY, CARB, PROTEIN, FAT, SODIUM)
        VALUES (#{energy}, #{carb}, #{protein}, #{fat}, #{sodium})
    </insert>

    <insert id="insertRecipe" parameterType="com.kh.ypjp.community.recipe.model.vo.Recipe" useGeneratedKeys="true" keyProperty="rcpNo">
        INSERT INTO RECIPE (
            USER_NO, RCP_NAME, CATEGORY_NO, NUTRIENT_NO, IMAGE_NO, INGREDIENT, APPROVAL, CREATED_AT
        ) VALUES (
            #{userNo}, #{rcpName}, #{categoryNo}, #{nutrientNo}, #{imageNo}, #{ingredient}, #{approval}, SYSDATE
        )
    </insert>

    <insert id="insertRecipeStep" parameterType="com.kh.ypjp.community.recipe.model.vo.RecipeStep">
        INSERT INTO RECIPE_STEP (RCP_NO, STEP_ORDER, DESCRIPTION, IMAGE_NO)
        VALUES (#{rcpNo}, #{stepOrder}, #{description}, #{imageNo})
    </insert>
</mapper>